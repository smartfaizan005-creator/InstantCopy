name: Build & Release APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK packages
        shell: bash
        run: |
          set -euo pipefail
          yes | sdkmanager --licenses > /dev/null || true
          sdkmanager "platforms;android-34" "build-tools;34.0.0" "platform-tools"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build release APK
        run: ./gradlew :android:assembleRelease

      - name: Determine version and locate APK
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          VERSION_NAME=$(grep -m1 -E 'versionName[[:space:]]*=' android/build.gradle.kts | sed -E 's/.*versionName[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/')
          if [[ -z "${VERSION_NAME}" ]]; then
            echo "Unable to determine versionName from android/build.gradle.kts" >&2
            exit 1
          fi

          TAG="v${VERSION_NAME}"

          APK_PATH=$(find android/build/outputs/apk/release -maxdepth 1 -type f -name "*.apk" | head -n 1 || true)
          if [[ -z "${APK_PATH}" ]]; then
            echo "Release APK not found under android/build/outputs/apk/release" >&2
            find android/build/outputs -maxdepth 5 -type f | sed 's/^/Found: /'
            exit 1
          fi

          APK_NAME=$(basename "${APK_PATH}")

          echo "version=${VERSION_NAME}" >> "${GITHUB_OUTPUT}"
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "apk_path=${APK_PATH}" >> "${GITHUB_OUTPUT}"
          echo "apk_name=${APK_NAME}" >> "${GITHUB_OUTPUT}"

          echo "Detected version: ${VERSION_NAME}"
          echo "Detected tag: ${TAG}"
          echo "APK: ${APK_PATH}"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: instantcopy-${{ steps.meta.outputs.tag }}-apk
          path: ${{ steps.meta.outputs.apk_path }}
          retention-days: 90

      - name: Create or update GitHub release (attach APK)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.meta.outputs.tag }}
          APK_PATH: ${{ steps.meta.outputs.apk_path }}
        shell: bash
        run: |
          set -euo pipefail

          TITLE="InstantCopy ${TAG}"
          NOTES="Automated release generated from commit ${GITHUB_SHA}."

          if gh release view "${TAG}" > /dev/null 2>&1; then
            echo "Release ${TAG} already exists. Uploading APK and updating notes..."
            gh release upload "${TAG}" "${APK_PATH}" --clobber
            gh release edit "${TAG}" --title "${TITLE}" --notes "${NOTES}"
          else
            echo "Creating new release ${TAG}..."
            gh release create "${TAG}" "${APK_PATH}" --title "${TITLE}" --generate-notes
          fi
